API listening http://localhost:5052
Using launch settings from C:\pfmp\PFMP-API\Properties\launchSettings.json...
Building...
info: Microsoft.Hosting.Lifetime[14]
      Now listening on: http://localhost:5052
info: Microsoft.Hosting.Lifetime[0]
      Application started. Press Ctrl+C to shut down.
info: Microsoft.Hosting.Lifetime[0]
      Hosting environment: Development
info: Microsoft.Hosting.Lifetime[0]
      Content root path: C:\pfmp\PFMP-API
info: PFMP_API.Controllers.AIIntelligenceController[0]
      Starting AI analysis for user 2
info: PFMP_API.Services.AI.AIIntelligenceService[0]
      Starting comprehensive financial analysis for user 2
fail: Microsoft.EntityFrameworkCore.Query[10100]
      An exception occurred while iterating over the results of a query for context type 'PFMP_API.ApplicationDbContext'.
      System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
         at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
      System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
         at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
fail: Microsoft.EntityFrameworkCore.Query[10100]
      An exception occurred while iterating over the results of a query for context type 'PFMP_API.ApplicationDbContext'.
      System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
         at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
      System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
         at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
fail: Microsoft.EntityFrameworkCore.Query[10100]
      An exception occurred while iterating over the results of a query for context type 'PFMP_API.ApplicationDbContext'.
      System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
         at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
      System.InvalidOperationException: A second operation was started on this context instance before a previous operation completed. This is usually caused by different threads concurrently using the same instance of DbContext. For more information on how to avoid threading issues with DbContext, see https://go.microsoft.com/fwlink/?linkid=2097913.
         at Microsoft.EntityFrameworkCore.Infrastructure.Internal.ConcurrencyDetector.EnterCriticalSection()
         at Microsoft.EntityFrameworkCore.Query.Internal.SingleQueryingEnumerable`1.AsyncEnumerator.MoveNextAsync()
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (37ms) [Parameters=[@__startDate_0='?' (DbType = DateTime), @__endDate_1='?' (DbType = DateTime)], CommandType='Text', CommandTimeout='30']
      SELECT m."MarketContextId", m."AffectedSectors", m."ContextDate", m."CryptoSentiment", m."DailySummary", m."GeneratedAt", m."GenerationCost", m."MajorEvents", m."MarketSentiment", m."ModelUsed", m."SPYChange", m."SourceArticleCount", m."TokensUsed", m."TreasuryYield10Y", m."VIXLevel"
      FROM "MarketContexts" AS m
      WHERE m."ContextDate" >= @__startDate_0 AND m."ContextDate" <= @__endDate_1
      ORDER BY m."ContextDate"
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (5ms) [Parameters=[@__userId_0='?' (DbType = Int32), @__cutoff_1='?' (DbType = DateTime)], CommandType='Text', CommandTimeout='30']
      SELECT a."ActionMemoryId", a."AccountsAffected", a."ActionDate", a."ActionSummary", a."ActionType", a."AmountMoved", a."AssetClass", a."ExpiresAt", a."IsSignificant", a."ReferenceCount", a."Referenced", a."SourceAdviceId", a."SourceAlertId", a."UserId"
      FROM "AIActionMemories" AS a
      WHERE a."UserId" = @__userId_0 AND a."ActionDate" >= @__cutoff_1
      ORDER BY a."ActionDate" DESC
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (8ms) [Parameters=[@__userId_0='?' (DbType = Int32), @__minConfidence_1='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30']
      SELECT a."UserMemoryId", a."ConfidenceScore", a."Context", a."DeprecatedAt", a."DeprecationReason", a."IsActive", a."LastReinforcedAt", a."LearnedAt", a."MemoryKey", a."MemoryType", a."MemoryValue", a."ReinforcementCount", a."SourceAdviceId", a."SourceConversationId", a."UserId"
      FROM "AIUserMemories" AS a
      WHERE a."UserId" = @__userId_0 AND a."IsActive" AND a."ConfidenceScore" >= @__minConfidence_1
      ORDER BY a."ConfidenceScore" DESC
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (3ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30']
      SELECT a."ConversationId", a."ConversationSummary", a."ConversationType", a."EndedAt", a."GeneratedAdvice", a."MessageCount", a."RelatedAdviceId", a."StartedAt", a."TotalCost", a."TotalTokensUsed", a."UserId"
      FROM "AIConversations" AS a
      WHERE a."UserId" = @__userId_0 AND a."EndedAt" IS NULL
      ORDER BY a."StartedAt" DESC
      LIMIT 1
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (DbType = Int32), @__cutoff_1='?' (DbType = DateTime)], CommandType='Text', CommandTimeout='30']
      SELECT a."ActionMemoryId", a."AccountsAffected", a."ActionDate", a."ActionSummary", a."ActionType", a."AmountMoved", a."AssetClass", a."ExpiresAt", a."IsSignificant", a."ReferenceCount", a."Referenced", a."SourceAdviceId", a."SourceAlertId", a."UserId"
      FROM "AIActionMemories" AS a
      WHERE a."UserId" = @__userId_0 AND a."IsSignificant" AND a."ActionDate" >= @__cutoff_1
      ORDER BY a."ActionDate" DESC
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[@__p_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30']
      SELECT u."UserId", u."AccountLockedUntil", u."AnnualIncome", u."AzureObjectId", u."BypassAuthentication", u."CreatedAt", u."DateOfBirth", u."DependentCount", u."Email", u."EmergencyFundTarget", u."EmploymentType", u."EnableEmailAlerts", u."EnablePushNotifications", u."EnableRebalancingAlerts", u."EnableTaxOptimization", u."FailedLoginAttempts", u."FirstName", u."GovernmentAgency", u."HouseholdServiceNotes", u."IsActive", u."IsGovernmentEmployee", u."IsTestAccount", u."LastLoginAt", u."LastName", u."LastRiskAssessment", u."LiquidityBufferMonths", u."MaritalStatus", u."PasswordHash", u."PayGrade", u."PhoneNumber", u."PreferredName", u."ProfileCompletedAt", u."ProfileSetupComplete", u."RebalancingThreshold", u."RetirementGoalAmount", u."RetirementSystem", u."RiskTolerance", u."ServiceComputationDate", u."SetupProgressPercentage", u."SetupStepsCompleted", u."TargetMonthlyPassiveIncome", u."TargetRetirementDate", u."UpdatedAt", u."VADisabilityMonthlyAmount", u."VADisabilityPercentage"
      FROM "Users" AS u
      WHERE u."UserId" = @__p_0
      LIMIT 1
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (4ms) [Parameters=[@__userId_0='?' (DbType = Int32)], CommandType='Text', CommandTimeout='30']
      SELECT c."CashAccountId", c."AccountType", c."Balance", c."CreatedAt", c."Institution", c."InterestRateApr", c."IsEmergencyFund", c."Nickname", c."RateLastChecked", c."UpdatedAt", c."UserId"
      FROM "CashAccounts" AS c
      WHERE c."UserId" = @__userId_0
info: PFMP_API.Services.AI.DualAIAdvisor[0]
      Dual AI request started: userId=, promptLength=307
info: PFMP_API.Services.AI.ClaudeService[0]
      Claude API call: model=claude-sonnet-4-20250514, promptLength=307, temperature=0.3
info: System.Net.Http.HttpClient.Default.LogicalHandler[100]
      Start processing HTTP request POST https://api.anthropic.com/v1/messages
info: System.Net.Http.HttpClient.Default.ClientHandler[100]
      Sending HTTP request POST https://api.anthropic.com/v1/messages
info: PFMP_API.Services.AI.GeminiService[0]
      Gemini API call: model=gemini-2.5-flash, promptLength=307, temperature=0.3
info: System.Net.Http.HttpClient.Default.LogicalHandler[100]
      Start processing HTTP request POST gemini-2.5-flash://generateContent?*
info: System.Net.Http.HttpClient.Default.ClientHandler[100]
      Sending HTTP request POST gemini-2.5-flash://generateContent?*
fail: PFMP_API.Services.AI.GeminiService[0]
      Gemini API exception (attempt 1/3)
      System.NotSupportedException: The 'gemini-2.5-flash' scheme is not supported.
         at Microsoft.Extensions.Http.Logging.LoggingHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at Microsoft.Extensions.Http.Logging.LoggingScopeHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 80
info: System.Net.Http.HttpClient.Default.LogicalHandler[100]
      Start processing HTTP request POST gemini-2.5-flash://generateContent?*
info: System.Net.Http.HttpClient.Default.ClientHandler[100]
      Sending HTTP request POST gemini-2.5-flash://generateContent?*
fail: PFMP_API.Services.AI.GeminiService[0]
      Gemini API exception (attempt 2/3)
      System.NotSupportedException: The 'gemini-2.5-flash' scheme is not supported.
         at Microsoft.Extensions.Http.Logging.LoggingHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at Microsoft.Extensions.Http.Logging.LoggingScopeHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 80
info: System.Net.Http.HttpClient.Default.LogicalHandler[100]
      Start processing HTTP request POST gemini-2.5-flash://generateContent?*
info: System.Net.Http.HttpClient.Default.ClientHandler[100]
      Sending HTTP request POST gemini-2.5-flash://generateContent?*
fail: PFMP_API.Services.AI.GeminiService[0]
      Gemini API exception (attempt 3/3)
      System.NotSupportedException: The 'gemini-2.5-flash' scheme is not supported.
         at Microsoft.Extensions.Http.Logging.LoggingHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at Microsoft.Extensions.Http.Logging.LoggingScopeHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 80
info: System.Net.Http.HttpClient.Default.ClientHandler[101]
      Received HTTP response headers after 11197.0232ms - 200
info: System.Net.Http.HttpClient.Default.LogicalHandler[101]
      End processing HTTP request after 11204.6794ms - 200
info: PFMP_API.Services.AI.ClaudeService[0]
      Claude success: recommendationId=b1c387de-63d6-4b42-8e51-5c97ec90731e, tokens=481, cost=$0.0059, confidence=80 %
fail: PFMP_API.Services.AI.DualAIAdvisor[0]
      Dual AI request failed: userId=
      System.InvalidOperationException: Gemini API failed after 3 attempts
       ---> System.NotSupportedException: The 'gemini-2.5-flash' scheme is not supported.
         at Microsoft.Extensions.Http.Logging.LoggingHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at Microsoft.Extensions.Http.Logging.LoggingScopeHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 80
         --- End of inner exception stack trace ---
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 127
         at PFMP_API.Services.AI.DualAIAdvisor.GetConsensusRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\DualAIAdvisor.cs:line 63
fail: PFMP_API.Services.AI.AIIntelligenceService[0]
      Error analyzing finances for user 2
      System.InvalidOperationException: Gemini API failed after 3 attempts
       ---> System.NotSupportedException: The 'gemini-2.5-flash' scheme is not supported.
         at Microsoft.Extensions.Http.Logging.LoggingHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at Microsoft.Extensions.Http.Logging.LoggingScopeHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 80
         --- End of inner exception stack trace ---
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 127
         at PFMP_API.Services.AI.DualAIAdvisor.GetConsensusRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\DualAIAdvisor.cs:line 63
         at PFMP_API.Services.AI.AIIntelligenceService.AnalyzeCashOptimizationAsync(Int32 userId) in C:\pfmp\PFMP-API\Services\AI\AIIntelligenceService.cs:line 121
         at PFMP_API.Services.AI.AIIntelligenceService.AnalyzeUserFinancesAsync(Int32 userId, Boolean forceAnalysis) in C:\pfmp\PFMP-API\Services\AI\AIIntelligenceService.cs:line 59
fail: PFMP_API.Controllers.AIIntelligenceController[0]
      Error analyzing finances for user 2
      System.InvalidOperationException: Gemini API failed after 3 attempts
       ---> System.NotSupportedException: The 'gemini-2.5-flash' scheme is not supported.
         at Microsoft.Extensions.Http.Logging.LoggingHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at Microsoft.Extensions.Http.Logging.LoggingScopeHttpMessageHandler.<SendCoreAsync>g__Core|4_0(HttpRequestMessage request, Boolean useAsync, CancellationToken cancellationToken)
         at System.Net.Http.HttpClient.<SendAsync>g__Core|83_0(HttpRequestMessage request, HttpCompletionOption completionOption, CancellationTokenSource cts, Boolean disposeCts, CancellationTokenSource pendingRequestsCts, CancellationToken originalCancellationToken)
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 80
         --- End of inner exception stack trace ---
         at PFMP_API.Services.AI.GeminiService.GetRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\GeminiService.cs:line 127
         at PFMP_API.Services.AI.DualAIAdvisor.GetConsensusRecommendationAsync(AIPromptRequest request) in C:\pfmp\PFMP-API\Services\AI\DualAIAdvisor.cs:line 63
         at PFMP_API.Services.AI.AIIntelligenceService.AnalyzeCashOptimizationAsync(Int32 userId) in C:\pfmp\PFMP-API\Services\AI\AIIntelligenceService.cs:line 121
         at PFMP_API.Services.AI.AIIntelligenceService.AnalyzeUserFinancesAsync(Int32 userId, Boolean forceAnalysis) in C:\pfmp\PFMP-API\Services\AI\AIIntelligenceService.cs:line 59
         at PFMP_API.Controllers.AIIntelligenceController.AnalyzeUserFinances(Int32 userId, Boolean force) in C:\pfmp\PFMP-API\Controllers\AIIntelligenceController.cs:line 43